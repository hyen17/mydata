javascript:(async () => {
  const sleep = ms => new Promise(r => setTimeout(r, ms));

  const totalQuestions = document.querySelectorAll('#questionsSelect option').length;
  const questionSelect = document.querySelector('#questionsSelect');
  const delayAfterChange = 2000;

  const topicName =
    document.querySelector('#topicName')?.innerText.trim() || 'Topic';

  const questions = [];
  let readingHTML = '';

  /* =========================
     STEP 1: PINDAH KE SOAL 1
     ========================= */
  questionSelect.selectedIndex = 0;
  questionSelect.dispatchEvent(new Event('change', { bubbles: true }));
  await sleep(delayAfterChange);

  alert(
    'Klik BAGIAN TERAKHIR dari READING di soal pertama.\n\n' +
    'Klik normal tetap dipakai.\n' +
    '<br> hanya digunakan jika klik normal gagal.'
  );

  const desc = document.querySelector('#description');
  if (!desc) {
    alert('#description tidak ditemukan.');
    return;
  }

  desc.style.outline = '2px dashed red';

  /* === HELPER ASLI (TIDAK DIUBAH) === */
  const getTopLevelChild = (container, node) => {
    let current = node;
    while (current && current.parentNode !== container) {
      current = current.parentNode;
    }
    return current;
  };

  /* =========================
     STEP 2: KLIK BATAS READING
     ========================= */
  const waitForClick = () =>
    new Promise(resolve => {
      const handler = e => {
        e.preventDefault();
        e.stopPropagation();

        if (!desc.contains(e.target)) {
          alert('Klik HARUS di dalam area soal.');
          return;
        }

        // ðŸ”¹ LOGIKA ASLI
        let boundaryNode = getTopLevelChild(desc, e.target);

        // ðŸ”¹ TAMBAHAN SAJA: fallback <br> JIKA GAGAL
        if (!boundaryNode) {
          const brs = desc.querySelectorAll('br');
          if (brs.length > 0) {
            boundaryNode = brs[brs.length - 1];
          }
        }

        if (!boundaryNode) {
          alert('Gagal menentukan batas reading.');
          return;
        }

        let node = boundaryNode.nextSibling;
        while (node) {
          const next = node.nextSibling;
          node.remove();
          node = next;
        }

        readingHTML = desc.innerHTML.trim();

        desc.style.outline = '';
        desc.removeEventListener('click', handler, true);
        resolve();
      };

      desc.addEventListener('click', handler, true);
    });

  await waitForClick();

  /* =========================
     HELPER: BERSIHKAN QUESTION (ASLI)
     ========================= */
  const cleanQuestionHTML = html => {
    let out = html.trim();

    if (readingHTML && out.startsWith(readingHTML)) {
      out = out.slice(readingHTML.length).trim();
    } else if (readingHTML && out.includes(readingHTML)) {
      out = out.replace(readingHTML, '').trim();
    }

    const temp = document.createElement('div');
    temp.innerHTML = out;

    let node = temp.firstChild;
    while (node) {
      if (
        (node.nodeType === Node.ELEMENT_NODE && node.tagName === 'BR') ||
        (node.nodeType === Node.TEXT_NODE && !node.textContent.trim())
      ) {
        const next = node.nextSibling;
        node.remove();
        node = next;
      } else {
        break;
      }
    }

    return temp.innerHTML.trim();
  };

  /* =========================
     STEP 3: LOOP SEMUA SOAL
     ========================= */
  for (let i = 0; i < totalQuestions; i++) {
    questionSelect.selectedIndex = i;
    questionSelect.dispatchEvent(new Event('change', { bubbles: true }));
    await sleep(delayAfterChange);

    const rawHTML =
      document.querySelector('#description')?.innerHTML.trim() || '';

    const questionText = cleanQuestionHTML(rawHTML);

    const explanation =
      document.querySelector('#correctAnswer')?.innerHTML.trim() || '';

    questions.push({ questionText, explanation });
  }

  /* =========================
     STEP 4: GENERATE HTML (ASLI)
     ========================= */
  const generateHTML = withAnswers => {
    const doc = document.implementation.createHTMLDocument();
    const style = document.createElement('style');
    style.textContent = `
      body { font-family: Arial, sans-serif; font-size: 17px; margin: 40px; }
      .topic-title { font-size: 22px; font-weight: bold; margin-bottom: 15px; }
      .reading { margin-bottom: 40px; }
      .question-block { page-break-inside: avoid; margin-bottom: 50px; }
      .question-title { font-weight: bold; margin-bottom: 10px; }
      .question-text { margin-bottom: 15px; }
      .explanation { margin-top: 15px; }
      .hr-line { border: 0; border-top: 2px solid #000; margin: 10px 0 15px; }
      .explanation p { margin: 0; }
    `;
    doc.head.appendChild(style);

    const topic = document.createElement('div');
    topic.className = 'topic-title';
    topic.textContent = topicName;
    doc.body.appendChild(topic);

    const reading = document.createElement('div');
    reading.className = 'reading';
    reading.innerHTML = readingHTML;
    doc.body.appendChild(reading);

    questions.forEach((q, idx) => {
      const block = document.createElement('div');
      block.className = 'question-block';

      const title = document.createElement('div');
      title.className = 'question-title';
      title.textContent = `Question ${idx + 1} of ${totalQuestions}`;
      block.appendChild(title);

      const hr = document.createElement('hr');
      hr.className = 'hr-line';
      block.appendChild(hr);

      const qt = document.createElement('div');
      qt.className = 'question-text';
      qt.innerHTML = q.questionText;
      block.appendChild(qt);

      if (withAnswers && q.explanation) {
        const exp = document.createElement('div');
        exp.className = 'explanation';
        exp.innerHTML = `<b><i>Answer:</i></b><br>${q.explanation}`;
        block.appendChild(exp);
      }

      doc.body.appendChild(block);
    });

    return '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
  };

  const openTab = (html, name) => {
    const win = window.open();
    win.document.open();
    win.document.write(html);
    win.document.close();
    win.document.title = name;
  };

  openTab(generateHTML(false), `${topicName} - Questions`);
  openTab(generateHTML(true), `${topicName} - Answers`);
})();
